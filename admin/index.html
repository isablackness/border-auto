<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админка — Border Auto</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>

<body class="dark">

<header>
  <img src="/images/logo.png" alt="Border Auto" />
  <nav>
    <a href="/">Главная</a>
    <a href="/catalog.html">Каталог</a>
    <a href="/contacts.html">Контакты</a>
  </nav>
</header>

<main>
  <h1>Добавить автомобиль</h1>

  <form id="carForm">
    <input name="brand" placeholder="Марка" required />
    <input name="model" placeholder="Модель" required />
    <input name="year" type="number" placeholder="Год" />
    <input name="price" type="number" placeholder="Цена (€)" />
    <input name="mileage" type="number" placeholder="Пробег (км)" />
    <textarea name="description" placeholder="Описание"></textarea>

    <label style="margin:14px 0;display:block;">
      Фото автомобиля (до 10):
    </label>

    <!-- ❗ СКРЫТЫЙ INPUT -->
    <input
      id="imagesInput"
      type="file"
      accept="image/*"
      multiple
      style="display:none;"
    />

    <button type="button" onclick="imagesInput.click()">
      Выбрать фотографии
    </button>

    <!-- ПРЕВЬЮ -->
    <div id="preview" style="margin-top:20px;"></div>

    <button type="submit" style="margin-top:20px;">
      Добавить автомобиль
    </button>
  </form>
</main>

<footer>© Border Auto</footer>

<script>
const imagesInput = document.getElementById("imagesInput");
const preview = document.getElementById("preview");
const form = document.getElementById("carForm");

let files = [];

imagesInput.addEventListener("change", () => {
  files = Array.from(imagesInput.files).slice(0, 10);
  renderPreview();
});

function renderPreview() {
  preview.innerHTML = "";

  files.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = e => {
      preview.innerHTML += `
        <div style="
          display:flex;
          align-items:center;
          gap:12px;
          margin-bottom:12px;
          background:#111;
          padding:10px;
          border-radius:8px;
        ">
          <img src="${e.target.result}"
               style="width:80px;height:100px;object-fit:cover;border-radius:6px;">
          <div>
            <div style="font-size:14px;margin-bottom:4px;">
              ${file.name}
            </div>
            <label>
              Порядок:
              <input type="number"
                     min="1"
                     value="${index + 1}"
                     data-index="${index}"
                     style="width:60px;">
            </label>
          </div>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  });
}

form.addEventListener("submit", async e => {
  e.preventDefault();

  const data = new FormData(form);

  const orderInputs = preview.querySelectorAll("input[type=number]");
  const orderedFiles = files
    .map((file, i) => ({
      file,
      order: parseInt(orderInputs[i].value, 10) || 999
    }))
    .sort((a, b) => a.order - b.order)
    .map(x => x.file);

  orderedFiles.forEach(file => data.append("images", file));

  const res = await fetch("/api/cars", {
    method: "POST",
    body: data
  });

  if (res.ok) {
    alert("Автомобиль добавлен");
    form.reset();
    preview.innerHTML = "";
    files = [];
  } else {
    alert("Ошибка при сохранении");
  }
});
</script>

</body>
</html>
